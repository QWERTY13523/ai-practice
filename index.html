<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æœ‰å£°ä¹¦ç”Ÿæˆå¹³å° (é«˜çº§ç‰ˆ)</title>
    <style>
        :root { --primary: #667eea; --success: #48bb78; --bg: #f5f7fa; }
        body { font-family: 'Segoe UI', sans-serif; max-width: 900px; margin: 0 auto; padding: 40px; background-color: var(--bg); color: #333; }
        
        .container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h1 { text-align: center; margin-bottom: 10px; color: #2d3748; }
        .subtitle { text-align: center; color: #718096; margin-bottom: 30px; font-size: 1.1em; }

        /* å¡ç‰‡å®¹å™¨ */
        .step-box { border: 1px solid #e2e8f0; padding: 30px; border-radius: 10px; margin-bottom: 25px; transition: 0.3s; background: #fff; }
        .step-box.active { border-color: var(--primary); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15); transform: translateY(-2px); }
        .step-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; color: #2d3748; display: flex; align-items: center; }
        .step-title::before { content: ''; display: inline-block; width: 6px; height: 24px; background: var(--primary); margin-right: 12px; border-radius: 3px; }

        /* æŒ‰é’®æ ·å¼ */
        button { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; transition: all 0.2s; }
        button:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        button:disabled { background: #cbd5e0; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-success { background: var(--success); }
        .btn-restart { background: #718096; }

        /* è¡¨æ ¼æ ·å¼ */
        .role-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
        .role-table th { background-color: #f7fafc; color: #4a5568; font-weight: 600; padding: 15px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        .role-table td { padding: 15px; border-bottom: 1px solid #e2e8f0; vertical-align: middle; }
        .role-table tr:last-child td { border-bottom: none; }
        .role-table tr:hover td { background-color: #f8fbff; }

        /* è¡¨å•æ§ä»¶ */
        .role-select { padding: 8px 12px; border-radius: 6px; border: 1px solid #cbd5e0; width: 100%; font-size: 14px; outline: none; transition: border 0.2s; }
        .role-select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        input[type="file"] { font-size: 13px; color: #718096; }

        /* è¿›åº¦æ¡ */
        #status-area { display: none; }
        .progress-container { background: #edf2f7; height: 12px; border-radius: 6px; overflow: hidden; margin: 20px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #48bb78, #38a169); width: 0%; transition: width 0.4s ease-in-out; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; background: #ebf8ff; color: #3182ce; margin-bottom: 10px; }

        /* ç»“æœåŒºåŸŸ */
        #result-area { display: none; text-align: center; background: #f0fff4; border: 1px solid #c6f6d5; }
        audio { width: 100%; margin-top: 20px; outline: none; border-radius: 30px; }

        /* å·¥å…·ç±» */
        .hidden { display: none !important; }
        .highlight-role { color: var(--primary); font-weight: bold; background: #ebf8ff; padding: 2px 6px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“š AI æ™ºèƒ½æœ‰å£°ä¹¦ç”Ÿæˆ</h1>
    <p class="subtitle">ä¸Šä¼ æ–‡æœ¬ -> æ™ºèƒ½æå–è§’è‰² -> å®šåˆ¶ä¸“å±éŸ³è‰² -> ç”Ÿæˆå¤§ç‰‡</p>

    <!-- ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ ä¸åˆ†æ -->
    <div class="step-box active" id="step1">
        <div class="step-title">ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å°è¯´æ–‡æœ¬</div>
        <p style="font-size: 14px; color: #718096; margin-bottom: 20px;">ç³»ç»Ÿå°†è‡ªåŠ¨ä½¿ç”¨ Qwen å¤§æ¨¡å‹åˆ†æå‰§æœ¬ä¸­çš„è§’è‰²ä¸æƒ…ç»ªã€‚</p>
        <div style="display: flex; gap: 15px; align-items: center;">
            <div style="flex: 1; position: relative;">
                <input type="file" id="fileInput" accept=".txt" style="width: 100%; padding: 12px; border: 2px dashed #cbd5e0; border-radius: 8px; background: #f7fafc; cursor: pointer;">
            </div>
            <button onclick="uploadAndAnalyze()" id="analyzeBtn">ğŸš€ åˆ†æå‰§æœ¬</button>
        </div>
    </div>

    <!-- ç¬¬äºŒæ­¥ï¼šè§’è‰²é…ç½® -->
    <div class="step-box hidden" id="step2">
        <div class="step-title">ç¬¬äºŒæ­¥ï¼šé…ç½®è§’è‰²éŸ³è‰²</div>
        <p style="font-size: 14px; color: #718096; margin-bottom: 15px;">
            ç³»ç»Ÿå·²æ£€æµ‹åˆ°ä»¥ä¸‹è§’è‰²ã€‚æ‚¨å¯ä»¥ä¸ºä»–ä»¬æŒ‡å®šé¢„ç½®éŸ³è‰²ï¼Œæˆ–ä¸Šä¼  3-10 ç§’çš„å¹²å£°è¿›è¡Œå…‹éš†ã€‚
            <br>
            <span style="color: var(--primary); font-size: 12px;">* æç¤ºï¼šæ—ç™½å¦‚æœä¸é€‰ï¼Œå°†é»˜è®¤ä½¿ç”¨ç¨³å¥çš„é¢„è®­ç»ƒéŸ³è‰²ï¼ˆCosyVoiceï¼‰ã€‚</span>
        </p>
        
        <table class="role-table">
            <thead>
                <tr>
                    <th width="20%">è§’è‰²å</th>
                    <th width="40%">é€‰æ‹©é¢„ç½®éŸ³è‰²</th>
                    <th width="40%">æˆ–ï¼šä¸Šä¼ å…‹éš†éŸ³é¢‘ (wav/mp3)</th>
                </tr>
            </thead>
            <tbody id="role-config-body">
                <!-- åŠ¨æ€å†…å®¹ -->
            </tbody>
        </table>

        <div style="text-align: right; margin-top: 25px;">
            <button onclick="startGeneration()" id="generateBtn" class="btn-success">âœ¨ å¼€å§‹åˆæˆæœ‰å£°ä¹¦</button>
        </div>
    </div>

    <!-- ç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆè¿›åº¦ -->
    <div class="step-box hidden" id="status-area">
        <div class="step-title">ç¬¬ä¸‰æ­¥ï¼šAI æ­£åœ¨æ¼”ç»ä¸­</div>
        <div style="text-align: center;">
            <span class="status-badge" id="status-badge">åˆå§‹åŒ–ä¸­...</span>
            <div class="progress-container">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <p id="detail-msg" style="color: #718096; font-size: 14px; font-family: monospace;">æ­£åœ¨è°ƒåº¦ GPU èµ„æº...</p>
        </div>
    </div>

    <!-- ç¬¬å››æ­¥ï¼šç»“æœå±•ç¤º -->
    <div class="step-box hidden" id="result-area">
        <h2>ğŸ‰ ç”Ÿæˆå®Œæ¯•ï¼</h2>
        <p style="color: #48bb78; font-size: 14px;">æ‚¨çš„æœ‰å£°ä¹¦å·²åˆ¶ä½œå®Œæˆï¼Œè¯·è¯•å¬æˆ–ä¸‹è½½ã€‚</p>
        
        <audio id="audio-player" controls></audio>
        
        <div style="margin-top: 30px; display: flex; justify-content: center; gap: 20px;">
            <a id="download-link" href="#" download="audiobook.mp3">
                <button class="btn-success">â¬‡ï¸ ä¸‹è½½ MP3æ–‡ä»¶</button>
            </a>
            <button onclick="location.reload()" class="btn-restart">ğŸ”„ åˆ¶ä½œä¸‹ä¸€æœ¬</button>
        </div>
    </div>
</div>

<script>
    const API_BASE = "http://localhost:8000"; 
    
    // === ğŸŒŸ é…ç½®é¢„ç½®éŸ³è‰²åˆ—è¡¨ ğŸŒŸ ===
    // è¿™é‡Œçš„ value å¿…é¡»å¯¹åº”åç«¯ resource/input_audio æ–‡ä»¶å¤¹é‡Œçš„çœŸå®æ–‡ä»¶å
    const PRESET_VOICES = [
        { name: "å­™æ‚Ÿç©º (é¢„è®¾)", value: "å­™æ‚Ÿç©º.wav" },
        { name: "é‡‘è§’å¤§ç‹ (é¢„è®¾)", value: "é‡‘è§’å¤§ç‹.wav" },
        { name: "é“¶è§’å¤§ç‹ (é¢„è®¾)", value: "é“¶è§’å¤§ç‹.wav" },
        { name: "å”åƒ§ (é¢„è®¾)", value: "å”åƒ§.wav" },
        { name: "ç”·å£° - æ²‰ç¨³", value: "male_01.wav" },
        { name: "ç”·å£° - æ¿€æ˜‚", value: "male_02.wav" },
        { name: "å¥³å£° - æ¸©æŸ”", value: "female_01.wav" },
        { name: "å¥³å£° - å¯çˆ±", value: "female_02.wav" }
    ];

    let currentTaskId = null;
    let timer = null;
    let analyzedRoles = [];

    // === 1. ä¸Šä¼ å¹¶åˆ†æ ===
    async function uploadAndAnalyze() {
        const fileInput = document.getElementById('fileInput');
        if (fileInput.files.length === 0) { alert("è¯·å…ˆé€‰æ‹© txt æ–‡ä»¶ï¼"); return; }

        const btn = document.getElementById('analyzeBtn');
        btn.disabled = true;
        btn.innerHTML = "ğŸ§  åˆ†æä¸­...";

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);

        try {
            const response = await fetch(`${API_BASE}/analyze`, { method: 'POST', body: formData });
            if (!response.ok) throw new Error("Server Error");
            
            const data = await response.json();

            if (data.roles && data.roles.length > 0) {
                analyzedRoles = data.roles; 
                renderRoleConfig(analyzedRoles);
                
                // åˆ‡æ¢ç•Œé¢
                document.getElementById('step1').classList.remove('active');
                document.getElementById('step2').classList.remove('hidden');
                setTimeout(() => document.getElementById('step2').classList.add('active'), 50);
            } else {
                alert("æœªåˆ†æå‡ºè§’è‰²ï¼Œè¯·æ£€æŸ¥æ–‡æœ¬å†…å®¹æˆ–æ ¼å¼ã€‚");
                btn.disabled = false;
                btn.innerHTML = "ğŸš€ åˆ†æå‰§æœ¬";
            }
        } catch (e) {
            console.error(e);
            alert("è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·ç¡®ä¿åå°å·²å¯åŠ¨ (python main_server.py)");
            btn.disabled = false;
            btn.innerHTML = "ğŸš€ åˆ†æå‰§æœ¬";
        }
    }

    // === 2. æ¸²æŸ“è§’è‰²è¡¨å• (å…³é”®ä¿®æ”¹) ===
    function renderRoleConfig(roles) {
        const tbody = document.getElementById('role-config-body');
        tbody.innerHTML = "";

        roles.forEach(role => {
            // âŒ åˆ é™¤äº†ä¹‹å‰çš„ if (role === "æ—ç™½") return; é€»è¾‘
            // ç°åœ¨æ—ç™½ä¹Ÿä¼šæ­£å¸¸æ¸²æŸ“å‡ºæ¥

            const tr = document.createElement('tr');
            
            // æ—ç™½ç‰¹æ®Šæ ·å¼
            const isNarrator = role === "æ—ç™½";
            const roleDisplay = isNarrator ? `<span class="highlight-role">æ—ç™½ (Narrator)</span>` : role;
            
            // ä¸‹æ‹‰æ¡†é»˜è®¤é€‰é¡¹ï¼šæ—ç™½æ˜¾ç¤ºâ€œé»˜è®¤ CosyVoiceâ€ï¼Œå…¶ä»–äººæ˜¾ç¤ºâ€œè‡ªåŠ¨åˆ†é…â€
            let defaultText = isNarrator ? "-- é»˜è®¤: CosyVoice (ç¨³å¥) --" : "-- è‡ªåŠ¨: ç³»ç»Ÿéšæœºåˆ†é… --";

            // ç”Ÿæˆä¸‹æ‹‰æ¡†é€‰é¡¹
            let optionsHtml = `<option value="">${defaultText}</option>`;
            PRESET_VOICES.forEach(v => {
                // ç®€å•çš„è‡ªåŠ¨åŒ¹é…é€»è¾‘
                const selected = v.name.includes(role) ? "selected" : "";
                optionsHtml += `<option value="${v.value}" ${selected}>${v.name}</option>`;
            });

            tr.innerHTML = `
                <td>${roleDisplay}</td>
                <td>
                    <select class="role-select" name="voice_select_${role}">
                        ${optionsHtml}
                    </select>
                </td>
                <td>
                    <input type="file" name="voice_file_${role}" accept=".wav,.mp3">
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // === 3. å¼€å§‹ç”Ÿæˆ (å…³é”®ä¿®æ”¹) ===
    async function startGeneration() {
        const btn = document.getElementById('generateBtn');
        btn.disabled = true;
        btn.innerHTML = "â³ æ­£åœ¨æäº¤ä»»åŠ¡...";

        const formData = new FormData();
        const fileInput = document.getElementById('fileInput');
        formData.append("file", fileInput.files[0]);

        // æ”¶é›†é…ç½® (å¯¹æ‰€æœ‰è§’è‰²ï¼ŒåŒ…æ‹¬æ—ç™½)
        analyzedRoles.forEach(role => {
            const fileInput = document.querySelector(`input[name="voice_file_${role}"]`);
            const selectInput = document.querySelector(`select[name="voice_select_${role}"]`);

            // ä¼˜å…ˆä½¿ç”¨ä¸Šä¼ çš„æ–‡ä»¶
            if (fileInput && fileInput.files.length > 0) {
                formData.append(`custom_voice_${role}`, fileInput.files[0]);
            } 
            // å…¶æ¬¡ä½¿ç”¨é¢„ç½®é€‰æ‹©
            else if (selectInput && selectInput.value) {
                formData.append(`preset_voice_${role}`, selectInput.value);
            }
            // å¦‚æœéƒ½ä¸é€‰ï¼Œåç«¯ä¼šæ ¹æ®è§’è‰²æ˜¯å¦ä¸ºæ—ç™½è¿›è¡Œé»˜è®¤å¤„ç†
        });

        try {
            const response = await fetch(`${API_BASE}/generate_step`, { method: 'POST', body: formData });
            const data = await response.json();
            
            currentTaskId = data.task_id;
            
            // åˆ‡æ¢ç•Œé¢
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2').classList.add('hidden');
            
            const statusArea = document.getElementById('status-area');
            statusArea.style.display = 'block'; // å¼ºåˆ¶æ˜¾ç¤º
            statusArea.classList.remove('hidden');
            setTimeout(() => statusArea.classList.add('active'), 50);

            // å¯åŠ¨è½®è¯¢
            timer = setInterval(checkStatus, 1000);

        } catch (e) {
            console.error(e);
            alert("æäº¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åå°æ—¥å¿—");
            btn.disabled = false;
            btn.innerHTML = "âœ¨ å¼€å§‹åˆæˆæœ‰å£°ä¹¦";
        }
    }

    // === 4. è½®è¯¢è¿›åº¦ ===
    async function checkStatus() {
        if (!currentTaskId) return;
        try {
            const response = await fetch(`${API_BASE}/status/${currentTaskId}`);
            const data = await response.json();

            // æ›´æ–° UI
            const percent = data.progress || 0;
            document.getElementById('progress-fill').style.width = percent + "%";
            
            const msg = data.message || "å¤„ç†ä¸­...";
            document.getElementById('detail-msg').innerText = msg;
            
            // çŠ¶æ€å¾½ç« 
            const badge = document.getElementById('status-badge');
            if (data.status === 'analyzing') badge.innerText = "ğŸ” æ­£åœ¨åˆ†æ";
            else if (data.status === 'generating') badge.innerText = "ğŸ™ï¸ æ­£åœ¨é…éŸ³";
            else if (data.status === 'completed') badge.innerText = "âœ… å®Œæˆ";

            if (data.status === 'completed') {
                clearInterval(timer);
                
                // æ˜¾ç¤ºç»“æœ
                document.getElementById('status-area').classList.add('hidden');
                const resultArea = document.getElementById('result-area');
                resultArea.classList.remove('hidden');
                resultArea.style.display = 'block';
                setTimeout(() => resultArea.classList.add('active'), 50);

                const audioUrl = `${API_BASE}${data.result_url}`;
                document.getElementById('audio-player').src = audioUrl;
                document.getElementById('download-link').href = audioUrl;
                
            } else if (data.status === 'failed') {
                clearInterval(timer);
                alert("ç”Ÿæˆå‡ºé”™ï¼š" + data.message);
                document.getElementById('status-badge').innerText = "âŒ å¤±è´¥";
                document.getElementById('status-badge').style.color = "red";
            }
        } catch (e) {
            console.error("è½®è¯¢å‡ºé”™", e);
        }
    }
</script>

</body>
</html>